{% extends 'admin_base.html' %}

{% block main%}

{% load static %}

<div class="card shadow m-5">
    <div class="card-body">
        <h5 class="p-2 text-warning" style="border-bottom: 2px solid orange;">Train dữ liệu nhận diện khuôn mặt</h5>

        <div class="container-fluid">
            <form method="post" name="signupForm" id="signup-form" onsubmit="return checkpassword()">
                {% csrf_token %}
                <div class="form-row">
                    <div class="col-sm-12">
                        <div class="form-group text-center">
                            <label style="font-size: 20px; font-weight: bold;">Lịch sử train </label>
                        </div>
                    </div>
                </div>

                <div id="training-status" style="display: none;">
                    <p><strong>Đang train dữ liệu...</strong></p>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                             aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
                    </div>
                </div>

                <table class="table" id="training-log">

                    <tbody>
                        {% for train_datetime in train_datetimes %}
                        <tr>
                            <td>{{ train_datetime }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td>Không có thông tin ngày giờ train</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                {% if messages %}
                {% for message in messages %}
                <div class="alert alert-success" role="alert">
                    {{ message }}
                </div>
                {% endfor %}
                {% else %}
                <div class="alert alert-info" role="alert">
                    Chưa có dữ liệu mới.
                </div>
                {% endif %}

                <button type="button" class="btn btn-primary btn-flat" name="train-btn" id="train-btn"
                        onclick="startTraining()">
                    Train
                </button>

            </form>

            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    const trainingLog = document.getElementById('training-log');

                    // Gửi yêu cầu lấy thông tin ngày giờ train
                    fetch('/timetrain/')
                        .then(response => response.json())
                        .then(data => {
                            const trainDatetimes = data.train_datetimes;
                            let html = '';
                            for (const datetime of trainDatetimes) {
                                html += `<tr><td>${datetime}</td></tr>`;
                            }
                            if (html === '') {
                                html = '<tr><td>Không có thông tin ngày giờ train</td></tr>';
                            }
                            trainingLog.innerHTML = html;
                            trainingLog.style.display = 'table';
                        })
                        .catch(error => {
                            console.error('Lỗi trong quá trình lấy thông tin ngày giờ train:', error);
                            // Xử lý lỗi (ví dụ: hiển thị thông báo lỗi cho người dùng)
                        });
                });
                function startTraining() {
                    const trainButton = document.getElementById('train-btn');
                    const trainingStatus = document.getElementById('training-status');
                    const trainingLog = document.getElementById('training-log');

                    // Ẩn nút Train và hiển thị thông báo Training
                    trainButton.style.display = 'none';
                    trainingStatus.style.display = 'block';

                    // Gửi yêu cầu train dữ liệu
                    fetch('/demorecognition/train/')
                        .then(() => {
                            // Quá trình train hoàn tất, chuyển hướng người dùng đến trang khác (ví dụ: trang chủ)
                            window.location.href = 'http://localhost:8000/ad_train/';
                        })
                        .catch(error => {
                            console.error('Lỗi trong quá trình train model:', error);
                            // Xử lý lỗi (ví dụ: hiển thị thông báo lỗi cho người dùng)
                        });
                }
            </script>
        </div>
    </div>
</div>

{% endblock %}